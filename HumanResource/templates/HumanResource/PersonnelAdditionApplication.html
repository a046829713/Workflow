{% extends "form_base.html" %}

{% load static %}
{% load my_filters %}

{% block static_file %}
<link rel="stylesheet" href="{% static 'HumanResource/PersonnelAdditionApplication.css' %}">
<script src="{% static 'HumanResource/PersonnelAdditionApplication.js' %}"></script>
{% endblock static_file %}

{% block title%}
人員補增申請表
{% endblock title %}


{% block content %}
<!-- 每一份文件的Title區域 -->
<div style="position: relative;">
    <h1 class="text-center">人員增補申請表</h1>
    <img src="{% static 'Company/YBICO_Logo.png' %}" alt="Description Image" style="position: absolute; top: 0; right: 0; height: 48px; width: 90px;">
</div>



<div class="accordion" id="accordionExample">
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne" style="background-color: rgb(190, 225, 247); text-align: center;">
            增補基本資料
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
            data-bs-parent="#accordionExample">
            <div class="accordion-body">
                <div class="custom-container">
                    <div class="mb-3 row">                        
                        <label for="" class="col-md-2 col-form-label fs-5">{{ form.corporate_sector.label }}<span class="text-danger">*</span></label>
                        <div class="col-md-10 mt-2">
                            {{ form.corporate_sector }}
                        </div>
                    </div>

                    <div class="mb-3 row">                        
                        <label for="" class="col-md-2 col-form-label fs-5">{{ form.add_job_title.label }}<span class="text-danger">*</span></label>
                        <div class="col-md-4 mt-2">
                            {{ form.add_job_title }}
                        </div>
                        <label for="" class="col-md-2 col-form-label fs-5">{{ form.outside_add_job_title.label }}<span class="text-danger">*</span></label>
                        <div class="col-md-4 mt-2">
                            {{ form.outside_add_job_title }}
                        </div>
                    </div>
                    

                    <div class="mb-3 row">                        
                        <label for="" class="col-md-2 col-form-label fs-5">{{ form.add_people.label }}<span class="text-danger">*</span></label>
                        <div class="col-md-10 mt-2">
                            {{ form.add_people }}
                        </div>
                    </div>
                    
                    <div class="mb-3 row">                        
                        <label for="" class="col-md-2 col-form-label fs-5">{{ form.add_people_reason_choice.label }}<span class="text-danger">*</span></label>
                        <div class="col-md-10 mt-2">
                            {{ form.add_people_reason_choice }}
                        </div>
                    </div>
                    <div class="mb-3 row">                        
                        <label for="" class="col-md-2 col-form-label fs-5"></label>
                        <div class="col-md-10 mt-2 row">
                            <div class="col-md-8"> 
                                {{ form.add_people_reason }}
                            </div>
                            
                            <div id= 'short_term_duration_area'class="col-md-4 mb-3 row" style="display:none;">                        
                                <label for="" class="col-md-5 col-form-label fs-5">{{ form.short_term_duration.label }}<span class="text-danger">*</span></label>
                                <div class="col-md-7 mt-2">
                                    {{ form.short_term_duration }}
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="mt-3 row">                        
                        <div class="col-md-2 fs-5" style="display: flex; align-items: center; height: 100px;">
                            檢附文件
                        </div>
                        
                        <div class="col-md-10 mt-2" style="border: 1px solid rgb(178, 177, 177); border-radius: 10px; padding: 10px;">
                            <div class="mt-3 row">
                                <label for="" class="col-md-2 col-form-label fs-5">1.{{ form.resource_no.label }}<span class="text-danger">*</span></label>
                                <div class="col-md-1">                            
                                    <button class="btn btn-outline-primary" onclick="return HandleNumberToCall();" type="button">
                                        <a href="#" target="_blank" id="href_url_to_check">查詢</a>
                                    </button>              
                                </div>                        
                                <div class="col-md-9 mt-2">                            
                                    {{ form.resource_no }}
                                </div>
                            </div>
                            <div class="mb-3 row">                        
                                <label for="" class="col-md-3 col-form-label fs-5">2.{{ form.unit_configuration.label }}<span class="text-danger">*</span></label>
                                <div class="col-md-9 mt-2">
                                    {% if not Reset %}
                                        {% for attachment in attachments %}
                                            {% if attachment.name == 'unit_configuration' %}
                                            最後上傳檔案:
                                            <a href="{{ attachment.file.url }}">{{ attachment.file.name }}</a>
                                            {% endif %}
                                        {% endfor %}
                                    {% endif %}
                                    {{ form.unit_configuration }}
                                </div>
                            </div>
                            <div class="mb-3 row">
                                <label for="" class="col-md-3 col-form-label fs-5">3.{{ form.interview_questions.label }}</label>
                                <div class="col-md-9 mt-2">
                                    {% if not Reset %}
                                    {% for attachment in attachments %}
                                    {% if attachment.name == 'interview_questions' %}
                                    最後上傳檔案:
                                    <a href="{{ attachment.file.url }}">{{ attachment.file.name }}</a>
                                    {% endif %}
                                    {% endfor %}
                                    {% endif %}
                                    {{ form.interview_questions }}
                                </div>
                                
                            </div>
                            <div class="mb-3 row">
                                <label for="" class="col-md-3 col-form-label fs-5">4.{{ form.other_documents.label }}</label>
                                <div class="col-md-9 mt-2">
                                    {% if not Reset %}
                                    {% for attachment in attachments %}
                                    {% if attachment.name == 'other_documents' %}
                                    最後上傳檔案:
                                    <a href="{{ attachment.file.url }}">{{ attachment.file.name }}</a>
                                    {% endif %}
                                    {% endfor %}
                                    {% endif %}
                                    {{ form.other_documents }}
                                    
                                </div>                                
                            </div>
                        </div>
                    </div>
                    
                    
                    <div class="mb-3 row">
                        <label for="" class="col-md-2 col-form-label fs-5">{{ form.work_content.label }}
                            <span class="text-danger">*</span>
                            <br>
                            <span class="text-secondary" style="font-size: 14px;"> 使職缺吸引力:工作內容明確、詳細並敘述說明本職務的價值</span>
                        </label>                        
                        <div class="col-md-10 mt-2">
                            {{ form.work_content }}
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="" class="col-md-2 col-form-label fs-5">{{ form.minimum_salary.label }}<span class="text-danger">*</span></label>                        
                        <div class="col-md-10 mt-2">
                            {{ form.minimum_salary }}
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="" class="col-md-2 col-form-label fs-5">{{ form.maximum_salary.label }}<span class="text-danger">*</span></label>                        
                        <div class="col-md-10 mt-2">
                            {{ form.maximum_salary }}
                        </div>
                    </div>
                    
                    <div class="mb-3 row">                    
                        <label for="" class="col-md-2 col-form-label fs-5">{{ form.management_responsibility.label }}<span class="text-danger">*</span></label>                        
                        <div class="col-md-10 mt-2">
                            {{ form.management_responsibility }}
                        </div>
                    </div>

                    <div class="mb-3 row">                    
                        <label for="" class="col-md-2 col-form-label fs-5">{{ form.work_outside.label }}<span class="text-danger">*</span></label>
                        <div class="col-md-10 mt-2">
                            {{ form.work_outside }}
                        </div>
                        
                    </div>
                    <div class="mb-3 row">
                        <label for="" class="col-md-2 col-form-label fs-5">職務條件程度<span class="text-danger">*</span></label>
                        <span class="col-md-2 mt-2">                            
                            依SOP作業
                        </span>                        
                        <div class="col-md-4 mt-2">
                            {{ form.work_ability }}
                            <div class="slider_value_text">中等</div>                            
                        </div>
                        <span class="col-md-2 mt-2">                            
                            靈活工作
                        </span>                            
                    </div>
                    <div class="mb-3 row">
                        <label for="" class="col-md-2 col-form-label fs-5"></label>
                        <span class="col-md-2 mt-2">                            
                            不需要
                        </span>                        
                        <div class="col-md-4 mt-2">
                            {{ form.industry_experience }}
                            <div class="slider_value_text">中等</div>                            
                        </div>
                        <span class="col-md-2 mt-2">                            
                            業界經驗
                        </span>                            
                    </div>
                    <div class="mb-3 row">
                        <label for="" class="col-md-2 col-form-label fs-5"></label>
                        <span class="col-md-2 mt-2">                            
                            不需要
                        </span>                        
                        <div class="col-md-4 mt-2">
                            {{ form.industry_connections }}
                            <div class="slider_value_text">中等</div>                            
                        </div>
                        <span class="col-md-2 mt-2">                            
                            業界人脈
                        </span>                            
                    </div>
                    <div class="mb-3 row">
                        <label for="" class="col-md-2 col-form-label fs-5"></label>
                        <span class="col-md-2 mt-2">                            
                            不需要
                        </span>                        
                        <div class="col-md-4 mt-2">
                            {{ form.industry_knowledge }}
                            <div class="slider_value_text">中等</div>                            
                        </div>
                        <span class="col-md-2 mt-2">                            
                            業界知識
                        </span>                            
                    </div>
                    <div class="mb-3 row">
                        <label for="" class="col-md-2 col-form-label fs-5"></label>
                        <span class="col-md-2 mt-2">                            
                            不需要
                        </span>                        
                        <div class="col-md-4 mt-2">
                            {{ form.school_knowledge_select }}
                            <div class="slider_value_text">中等</div>                            
                        </div>
                        <span class="col-md-2 mt-2">                            
                            學校知識
                        </span>                            
                    </div>
                    <div class="mb-3 row">
                        <label for="" class="col-md-2 col-form-label fs-5"></label>
                        <span class="col-md-2 mt-2">                            
                            企業內有的知識
                        </span>                        
                        <div class="col-md-4 mt-2">
                            {{ form.business_knowledge }}
                            <div class="slider_value_text">中等</div>                            
                        </div>
                        <span class="col-md-2 mt-2">                            
                            企業內沒有的知識
                        </span>                            
                    </div>                    
                </div>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header" id="headingOne" style="background-color: rgb(190, 225, 247); text-align: center;">
            需求職缺條件
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne"
            data-bs-parent="#accordionExample">
            <div class="accordion-body">
                <div class="custom-container">
                    <div class="mb-3 row">                        
                        <label for="" class="col-md-2 col-form-label fs-5">{{ form.gender.label }}<span class="text-danger">*</span></label>
                        <div class="col-md-10 mt-2">
                            {{ form.gender }}
                        </div>
                    </div>                    
                    <div class="mb-3 row">
                        <label for="" class="col-md-2 col-form-label fs-5">{{ form.age.label }}<span class="text-danger">*</span></label>
                        <div class="col-md-10 mt-2">
                            {{ form.age }}
                            {{ form.age_input }}                    
                        </div>
                    </div>
                    <div class="mb-3 row">
                        <label for="" class="col-md-2 col-form-label fs-5">{{ form.licenses.label }}</label>
                        <div class="col-md-10 mt-2">
                            <div class="d-flex justify-content-around" style="margin-left: -30px;">
                                {% for choice in form.licenses.field.choices %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" value="{{ choice.0 }}" id="{{ choice.0 }}"
                                            name="{{ form.licenses.name }}" {% if choice.0 in form.licenses.value %}checked{% endif %}>
                                        <label class="form-check-label  fs-4" for="{{ choice.0 }}">{{ choice.1 }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- 教育程度 -->
                    <div class="mb-3 row">
                        <label for="{{ form.custom_education_level.id_for_label }}" class="col-md-2 col-form-label fs-5">{{ form.custom_education_level.label }}<span class="text-danger">*</span></label>
                        <div class="col-md-10 mt-2" style="margin-left: -46px;">
                            <div class="mb-3 row">                                
                                <div id="custom_education_level" class="col-md-12">
                                    <div class="d-flex justify-content-around"  >
                                        {% for choice in form.custom_education_level.field.choices %}
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" value="{{ choice.0 }}"
                                                name="{{ form.custom_education_level.name }}" {% if choice.0 in form.custom_education_level.value %}checked{% endif %}>
                                            <label class="form-check-label  fs-5" for="{{ choice.0 }}">{{ choice.1 }}</label>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 科系 -->
                    <div class="mb-3 row">                        
                        <label for="{{ form.department_school.id_for_label }}" class="col-md-2 col-form-label fs-5">{{ form.department_school.label }}<span class="text-danger">*</span></label>
                        <div class="col-md-10 mt-2">
                            <div class="mb-3 row">
                                {% for choice in form.department_school.field.choices %}
                                <div class="col-md-2 form-check">
                                    <input class="form-check-input department-choice" type="radio" value="{{ choice.0 }}"
                                        name="{{ form.department_school.name }}" {% if choice.0 in form.department_school.value %}checked{% endif %}
                                        {% if forloop.first %}required{% endif %}>
                                    <label class="form-check-label  fs-5" for="{{ choice.0 }}">{{ choice.1 }}</label>
                                </div>
                                {% endfor %}
                                <div id="custom-department" style="display: none;" class="col-md-6">
                                    {{ form.custom_department }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 相關工作經驗 -->
                    <div class="mb-5 row">
                        <label for="{{ form.work_experience.id_for_label }}" class="col-md-2 col-form-label  fs-5">{{ form.work_experience.label }}<span class="text-danger">*</span></label>                       
                        <div class="col-md-10 mt-2">
                            <div class="mb-3 row">
                                {% for choice in form.work_experience.field.choices %}
                                    <div class="col-md-2 form-check">
                                        <input class="form-check-input work_experience-choice" type="radio" value="{{ choice.0 }}"
                                            name="{{ form.work_experience.name }}" {% if choice.0 in form.work_experience.value %}checked{% endif %}
                                            {% if forloop.first %}required{% endif %}>
                                        <label class="form-check-label  fs-5" for="{{ choice.0 }}">{{ choice.1 }}</label>
                                    </div>
                                {% endfor %}                                
                                <div class="col-md-4">
                                    {{ form.job_title }}
                                </div>
                                <div class="col-md-2">
                                    <label for="{{ form.work_years.id_for_label }}" class=" col-form-label  fs-5" style="display:none;" id="work_years_label">{{ form.work_years.label }}</label>
                                </div>
                                <div class="col-md-2" >
                                    {{ form.work_years }}
                                </div>                                
                            </div>                            
                        </div>                        
                    </div>
                    <!-- school Knowledge -->
                    <div class="mb-3 row">
                        <label for="school_knowledge" class="col-md-2 col-form-label fs-5">{{ form.school_knowledge.label }}</label>
                        <div class="col-md-10 mt-2">
                            <label for="school_knowledge" class="form-label text-secondary">(只能在學校慢慢學，沒辦法離開再學的知識) EX: 化工知識</label>
                            {{ form.school_knowledge }}
                        </div>

                    </div>    
                    <!-- work Knowledge -->
                    <div class="mb-3 row">
                        <label for="work_knowledge" class="col-md-2 col-form-label fs-5">{{ form.work_knowledge.label }}</label>
                        <div class="col-md-10 mt-2">
                            {{ form.work_knowledge }}
                        </div>                        
                    </div>
                    <!-- 語言能力 -->
                    <!-- language -->
                    <div class="mt-3">
                        {% for formset in formsets %}
                        {{ formset.management_form }}
                        {% for each_form in formset %}
                        <div class="mb-3 row">
                            {% if forloop.parentloop.counter == 1 %}
                            <label for="{{  each_form.language.id_for_label }}" class="col-md-2 col-form-label  fs-5">{{  each_form.language.label }}</label>
                            {% else %}
                            <span  class="col-md-2"></span>
                            {% endif %}
                            <div class="col-md-10 language_group">
                                
                                <div class="d-flex justify-content-around mb-2">
                                    {{ each_form.language }}
                                    <label class="form-label " style="margin-left: 20px;">聽</label>
                                    {{ each_form.listen }}
                                    <label class="form-label " style="margin-left: 20px;">說</label>
                                    {{ each_form.speak }}
                                    <label class="form-label " style="margin-left: 20px;">讀</label>
                                    {{ each_form.read }}
                                    <label class="form-label " style="margin-left: 20px;">寫</label>
                                    {{ each_form.write }}
                                    {% if forloop.parentloop.counter != 1 %}
                                        <button  type="button" class="btn btn-outline-danger clear_language_form">X</button>
                                    {% else %}
                                        <span>&emsp;&emsp;</span>  
                                    {% endif %}
                                    
                                </div>
                            </div>
                        </div>
                        
                        {% endfor %}
                    {% endfor %}
                    </div>
                    

                    <div class="row">
                        <span class="col-md-2"></span>
                        <div class='col-md-10'>
                            <button id="add_language" type="button" class="btn btn-outline-success ">+</button>
                            <span class=" fw-bold">&nbsp;&nbsp;新增語文</span>
                        </div >
                       
                    </div>
                    <div class="mt-3 row">
                        <span class="col-md-2 fs-5 mt-3">擅長工具</span>
                        <span class="col-md-10 fs-5 mt-3">工具種類                            
                            <button class="btn btn-outline-primary" type="button"><a href="{% url 'download_pdf' pdf_filename='擅長工具.pdf' %}" target="_blank">清單列表</a></button>
                        </span>
                        <div class="mt-3 row">
                            {% for formset in Toolformsets %}                                
                                <div class="col-md-12 row tool_container">
                                    <span class="col-md-2 fs-5"></span>
                                    <div class="col-md-9">
                                        <div class="d-flex justify-content-around mt-3 ">
                                            {{ formset.management_form }}
                                            {% for form in formset %}
                                                {{ form.first_level }}
                                                {{ form.second_level }}
                                                {{ form.third_level }}                                                
                                            {% endfor %}                                
                                        </div>
                                    </div>
                                    <div class="col-md-1 mt-3">                                        
                                        <div >
                                            <button  type="button" class="btn btn-outline-danger clear_tool_form">刪除</button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <span class="col-md-2"></span>
                        <div class="col-md-10 mt-3">
                            <button id="addToolform" type="button" class="btn btn-outline-primary">+</button>
                            <span class="text-primary fw-bold">&nbsp;&nbsp;增加一欄</span>
                        </div>
                    </div>
                    <div class="mt-3 row">
                        <span class="col-md-2 fs-5 mt-3">工作專業技能</span>
                        <span class="col-md-10 fs-5 mt-3">技能種類
                            <button class="btn btn-outline-primary" type="button"><a href="{% url 'download_pdf' pdf_filename='工作技能.pdf' %}" target="_blank">清單列表</a></button>
                        </span>

                        <div class="mt-3 row">
                            {% for formset in SkillFormSets %}                                
                                <div class="col-md-12 row skill_container">
                                    <span class="col-md-2 fs-5"></span>
                                    <div class="col-md-9">
                                        <div class="d-flex justify-content-around mt-3 ">
                                            {{ formset.management_form }}
                                            {% for form in formset %}
                                                {{ form.skill_first_level }}
                                                {{ form.skill_second_level }}
                                                {{ form.skill_third_level }}                                                
                                            {% endfor %}                                
                                        </div>
                                    </div>
                                    <div class="col-md-1 mt-3">                                        
                                        <div >
                                            <button  type="button" class="btn btn-outline-danger clear_skill_form">刪除</button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <span class="col-md-2"></span>
                        <div class="col-md-10 mt-3">
                            <button id="addskillform" type="button" class="btn btn-outline-primary">+</button>
                            <span class="text-primary fw-bold">&nbsp;&nbsp;增加一欄</span>
                        </div>
                    </div>

                    <div class="mt-3 row">
                        <label for="{{ form.certificates.id_for_label }}" class="col-md-2 col-form-label fs-5">{{ form.certificates.label }}</label>
                        <div class="col-md-10">
                            {{ form.certificates }}
                        </div>                        
                    </div>
                    <div class="mt-3 row">
                        <label for="{{ form.additional_notes.id_for_label }}" class="col-md-2 col-form-label fs-5">{{ form.additional_notes.label }}</label>
                        <div class="col-md-10">
                            {{ form.additional_notes }}
                        </div>                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>






<div class="d-flex justify-content-around">
    <h5 class="text-center ">文件編號:HR-005-01</h5>
    <h5 class="text-center ">版次:A</h5>
</div>

<!-- 用來給javescript取用 -->
<div id="data_pass_area" style="display: none;">{{ form.data }}</div>
{% endblock content %}


{% block extra_js_body %}
<script type="text/javascript">
    $(document).ready(function(){
        $('input[type="range"]').on('input', function() {
            var value = $(this).val();
            var text;
            switch(value) {
                case '1':
                    text = "偏左傾向";
                    break;
                case '2':
                    text = "中等";
                    break;
                case '3':
                    text = "偏右傾向";
                    break;
            }            
            $(this).parent().find('.slider_value_text').text(text);
        });
    });


    function toggleDepartmentRequiredState(isRequired) {
        $("#custom-department input").prop('required', isRequired);
    }
    
    $(".department-choice ").on("change", function () {
        if ($(this).val() == '科系限制') {            
            $("#custom-department").show();
            toggleDepartmentRequiredState(true);
        } else {
            $("#custom-department").hide();
            $("#custom-department input").val("");  // 清空自定义科系输入字段的值
            toggleDepartmentRequiredState(false);
        }
    });

    // 初始狀態檢查
    if ($(".department-choice:checked").val() == "科系限制") {
        $("#custom-department").show();
        toggleDepartmentRequiredState(true);
    } else {
        toggleDepartmentRequiredState(false);
    }



    function showHiddenForm(selector, callback) {
        var $hiddenForms = $(selector);
        if ($hiddenForms.length > 0) {
            var $form = $hiddenForms.first();
            $form.removeClass(selector.substring(1));  // remove the dot from the class selector
            if (typeof callback === "function") {
                callback();  // call the callback function if it is provided and is a function
            }
        }
    }
    $('#addskillform').on('click', function () {
        showHiddenForm('.hiddenskill', function () { });
    });

    $(document).ready(function () {
        // id_Tool_expert==================================================
        // 思考上非異步綁定
        // 设置每个 first_level 选择框的更改事件处理程序
        $('select[id^="id_Tool_expert"][id$="-first_level"]').change(function () {
            var selectedValue = $(this).val();
            // 找到相应的 second_level 选择框
            var secondLevelSelect = $(this).parent().find('select[id$="-second_level"]');
            // 发送 AJAX 请求以获取 second_level 的选项
            $.get("{% url 'get_level_ajax' %}", {first_level: selectedValue}, function (data) {
                secondLevelSelect.empty();
                $.each(data.second_level, function (key, value) {
                    secondLevelSelect.append($('<option></option>').attr('value', key).text(value));
                });
            });

            // 清空選項3
            $(this).parent().find('select[id$="-third_level"]').empty();
        });
        // 为 second_level 设置更改事件处理程序，类似于上述代码
        $('select[id^="id_Tool_expert"][id$="-second_level"]').change(function () {
            var selectedValue = $(this).val();
            var firstLevelValue = $(this).parent().find('select[id$="-first_level"]').val();
            var thirdLevelSelect = $(this).parent().find('select[id$="-third_level"]');
            $.get("{% url 'get_level_ajax' %}", {first_level: firstLevelValue, second_level: selectedValue}, function (data) {
                thirdLevelSelect.empty();
                $.each(data.third_level, function (key, value) {
                    thirdLevelSelect.append($('<option></option>').attr('value', key).text(value));
                });
            });
        });
        // id_Tool_expert==================================================


        // id_Tool_expert async==================================================
        async function get_second_level_data(object) {
            var selectedValue = object.val();
            let url = "{% url 'get_level_ajax' %}" + "?first_level=" + selectedValue; // Append data as query parameter
            var secondLevelSelect = object.parent().find('select[id$="-second_level"]');
            let response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            if (response.ok) {
                let data = await response.json();
                secondLevelSelect.empty();
                $.each(data.second_level, function (key, value) {
                    secondLevelSelect.append($('<option></option>').attr('value', key).text(value));
                });
            } else {
                console.error('AJAX 请求失败');
            }
        }
        
        async function get_third_level_data(object) {
            var selectedValue =object.val();
            var firstLevelValue = object.parent().find('select[id$="-first_level"]').val();
            var thirdLevelSelect = object.parent().find('select[id$="-third_level"]');
            let url = "{% url 'get_level_ajax' %}" + "?first_level=" + firstLevelValue +'&' + "second_level="+ selectedValue; // Append data as query parameter
            
            let response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            if (response.ok) {
                let data = await response.json();
                thirdLevelSelect.empty();
                $.each(data.third_level, function (key, value) {
                    thirdLevelSelect.append($('<option></option>').attr('value', key).text(value));
                });
            } else {
                console.error('AJAX 请求失败');
            }
        }

        // id_Tool_expert async==================================================
        async function create_tool_first_level() {
            // 获取所有 first_level 选择框
            const selects = $('select[id^="id_Tool_expert"][id$="-first_level"]').toArray();

            $('.first_level').select2({
                width: '100%'  // 設置寬度為100%
            });
            $('.second_level').select2({
                width: '100%'  // 設置寬度為100%
            });
            $('.third_level').select2({
                width: '100%'  // 設置寬度為100%
            });
            
            // 使用 Promise.    all 等待所有请求完成
            await Promise.all(selects.map(async select => {
                var firstLevelSelect = $(select);
                // 使用 fetch 发送 AJAX 请求以获取 first_level 的选项
                let response = await fetch("{% url 'get_level_ajax' %}");
                let data = await response.json();
                firstLevelSelect.empty();
                $.each(data.first_level, function (key, value) {
                    firstLevelSelect.append($('<option></option>').attr('value', key).text(value));
                });
            }));
            // 等待所有 AJAX 请求和选项填充完成后，设置默认值
            var formDataString = $("#data_pass_area").text();
            // 用隱藏的資料來把儲存的表單寫回去
            // 檢查是否有資料
            if (formDataString !== '<MultiValueDict: {}>') {
                // 如果有資料，則進行處理
                var correctedString = formDataString.replace(/'/g, '"');
                // 在這里添加 try-catch 可以捕捉 JSON 解析過程中可能出現的錯誤
                try {
                    var formData = JSON.parse(correctedString);
                    var firstLevelSelects = $('select[id^="id_Tool_expert"][id$="-first_level"]').toArray();

                    let count_num = 0
                    for (let select of firstLevelSelects) {                        
                        var partNameKey = `Tool_expert${count_num}-0-first_level`;
                        var initialData = formData[partNameKey];
                        if (initialData) {
                            $(select).val(initialData).trigger('change');
                            await get_second_level_data($(select));
                        } 
                        count_num+=1
                    }
                    // 這邊就可以呼叫第二個類別的資料了
                    var SecondLevelSelects = $('select[id^="id_Tool_expert"][id$="-second_level"]').toArray();
                    let count_num2 = 0
                    for (let select of SecondLevelSelects) {                        
                        var partNameKey = `Tool_expert${count_num2}-0-second_level`;
                        var initialData = formData[partNameKey];
                        if (initialData) {
                            $(select).val(initialData).trigger('change');
                            await get_third_level_data($(select));
                        } 
                        count_num2+=1
                    }

                    // 測試第三個類別的資料
                    var ThirdLevelSelects = $('select[id^="id_Tool_expert"][id$="-third_level"]').toArray();
                    let count_num3 = 0
                    for (let select of ThirdLevelSelects) {                        
                        var partNameKey = `Tool_expert${count_num3}-0-third_level`;
                        var initialData = formData[partNameKey];
                        if (initialData) {
                            $(select).val(initialData).trigger('change');
                        } 
                        count_num3+=1
                    }


                } catch (e) {
                    console.error("JSON 解析錯誤:", e);
                }
            }
            // 將多餘的工具隱藏起來
            $('.tool_container').each(function (index) {
                // 1 或0都可以調整
                if (index >= 0) {
                    let isEmpty = true;
                    let first_level = $(this).find('select[name*="first_level"]').val();
                    let second_level = $(this).find('select[name*="second_level"]').val();
                    let third_level = $(this).find('select[name*="third_level"]').val();  // 改成 select
                    if (first_level || second_level || third_level) {
                        isEmpty = false;
                    }
                    if (isEmpty) {
                        $(this).addClass('hiddentool');                        
                    }
                }
            });
        }


        // 初始化商品
        create_tool_first_level()

        // work_skill =============================================================================================================
        async function get_work_skill_second_level_data(object) {
            var selectedValue = object.val();
            let url = "{% url 'get_skill_level_ajax' %}" + "?first_level=" + selectedValue; // Append data as query parameter
            var secondLevelSelect = object.parent().find('select[id$="_second_level"]');
            let response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            if (response.ok) {
                let data = await response.json();
                secondLevelSelect.empty();
                $.each(data.second_level, function (key, value) {
                    secondLevelSelect.append($('<option></option>').attr('value', key).text(value));
                });
            } else {
                console.error('AJAX 请求失败');
            }
        }

        async function get_work_skill_third_level_data(object) {
            var selectedValue =object.val();
            var firstLevelValue = object.parent().find('select[id$="_first_level"]').val();
            var thirdLevelSelect = object.parent().find('select[id$="_third_level"]');
            let url = "{% url 'get_skill_level_ajax' %}" + "?first_level=" + firstLevelValue +'&' + "second_level="+ selectedValue; // Append data as query parameter
            
            let response = await fetch(url, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                },
            });
            if (response.ok) {
                let data = await response.json();
                thirdLevelSelect.empty();
                $.each(data.third_level, function (key, value) {
                    thirdLevelSelect.append($('<option></option>').attr('value', key).text(value));
                });
            } else {
                console.error('AJAX 请求失败');
            }
        }


        async function create_work_skill_level(){
            // 获取所有 workskiell first_level 选择框
            const selects = $('select[id^="id_work_skill"][id$="_first_level"]').toArray();
            $('.skill_first_level').select2({
                width: '100%'  // 設置寬度為100%
            });
            $('.skill_second_level').select2({
                width: '100%'  // 設置寬度為100%
            });
            $('.skill_third_level').select2({
                width: '100%'  // 設置寬度為100%
            });
            // 使用 Promise.all 等待所有请求完成
            await Promise.all(selects.map(async select => {
                var firstLevelSelect = $(select);
                // 使用 fetch 发送 AJAX 请求以获取 first_level 的选项
                let response = await fetch("{% url 'get_skill_level_ajax' %}");
                let data = await response.json();
                firstLevelSelect.empty();
                $.each(data.first_level, function (key, value) {
                    firstLevelSelect.append($('<option></option>').attr('value', key).text(value));
                });
            }));
            // 等待所有 AJAX 请求和选项填充完成后，设置默认值
            var formDataString = $("#data_pass_area").text();
            // 用隱藏的資料來把儲存的表單寫回去
            // 檢查是否有資料
            if (formDataString !== '<MultiValueDict: {}>') {
                // 如果有資料，則進行處理
                var correctedString = formDataString.replace(/'/g, '"');
                // 在這里添加 try-catch 可以捕捉 JSON 解析過程中可能出現的錯誤
                try {
                    var formData = JSON.parse(correctedString);
                    var firstLevelSelects = $('select[id^="id_work_skill"][id$="_first_level"]').toArray();

                    let count_num = 0
                    for (let select of firstLevelSelects) {                        
                        var partNameKey = `work_skill${count_num}-0-skill_first_level`;
                        var initialData = formData[partNameKey];
                        if (initialData) {
                            $(select).val(initialData).trigger('change');
                            await get_work_skill_second_level_data($(select));
                        } 
                        count_num+=1
                    }
                    // 這邊就可以呼叫第二個類別的資料了
                    var SecondLevelSelects = $('select[id^="id_work_skill"][id$="_second_level"]').toArray();
                    let count_num2 = 0
                    for (let select of SecondLevelSelects) {                        
                        var partNameKey = `work_skill${count_num2}-0-skill_second_level`;
                        var initialData = formData[partNameKey];
                        if (initialData) {
                            $(select).val(initialData).trigger('change');
                            await get_work_skill_third_level_data($(select));
                        } 
                        count_num2+=1
                    }

                    // 測試第三個類別的資料
                    var ThirdLevelSelects = $('select[id^="id_work_skill"][id$="_third_level"]').toArray();
                    let count_num3 = 0
                    for (let select of ThirdLevelSelects) {                        
                        var partNameKey = `work_skill${count_num3}-0-skill_third_level`;
                        var initialData = formData[partNameKey];
                        if (initialData) {
                            $(select).val(initialData).trigger('change');
                        } 
                        count_num3+=1
                    }
                } catch (e) {
                    console.error("JSON 解析錯誤:", e);
                }
            }
            $('.skill_container').each(function (index) {
                // 1 或0都可以調整
                if (index >= 0) {
                    let isEmpty = true;
                    let first_level = $(this).find('select[name*="first_level"]').val();
                    let second_level = $(this).find('select[name*="second_level"]').val();
                    let third_level = $(this).find('select[name*="third_level"]').val();  // 改成 select
                    if (first_level || second_level || third_level) {
                        isEmpty = false;
                    }
                    
                    if (isEmpty) {
                        $(this).addClass('hiddenskill');                        
                    }
                }
            });
        }
        
        create_work_skill_level()
        

        // 设置每个 first_level 选择框的更改事件处理程序
        $('select[id^="id_work_skill"][id$="_first_level"]').change(function () {
            var selectedValue = $(this).val();
            // 找到相应的 second_level 选择框
            var secondLevelSelect = $(this).parent().find('select[id$="_second_level"]');
            // 发送 AJAX 请求以获取 second_level 的选项
            $.get("{% url 'get_skill_level_ajax' %}", { first_level: selectedValue }, function (data) {
                secondLevelSelect.empty();
                $.each(data.second_level, function (key, value) {
                    secondLevelSelect.append($('<option></option>').attr('value', key).text(value));
                });
            });
        });

        // 为 second_level 设置更改事件处理程序，类似于上述代码
        $('select[id^="id_work_skill"][id$="_second_level"]').change(function () {
            var selectedValue = $(this).val();
            var firstLevelValue = $(this).parent().find('select[id$="_first_level"]').val();
            var thirdLevelSelect = $(this).parent().find('select[id$="_third_level"]');
            $.get("{% url 'get_skill_level_ajax' %}", { first_level: firstLevelValue, second_level: selectedValue }, function (data) {
                thirdLevelSelect.empty();
                $.each(data.third_level, function (key, value) {
                    thirdLevelSelect.append($('<option></option>').attr('value', key).text(value));
                });
            });
        });

        // 初始化類
        $('.first_level, .second_level, .third_level').change(function () {
            // 当任一select元素改变时，检查所有的select元素
            $('.first_level, .second_level, .third_level').each(function() {
                if ($(this).val()) {  // 如果有值被选中
                    // 重置边框颜色为默认
                    $(this).next('.select2').find('.select2-selection').css('border', '1px solid #ccc');
                } else {  // 如果没有值被选中
                    // 设置边框颜色为红色
                    $(this).next('.select2').find('.select2-selection').css('border', '1px solid red');
                }
            });
        });

        // 初始化類
        $('.skill_first_level, .skill_second_level, .skill_third_level').change(function () {
            // 当任一select元素改变时，检查所有的select元素
            $('.skill_first_level, .skill_second_level, .skill_third_level').each(function() {
                if ($(this).val()) {  // 如果有值被选中
                    // 重置边框颜色为默认
                    $(this).next('.select2').find('.select2-selection').css('border', '1px solid #ccc');
                } else {  // 如果没有值被选中
                    // 设置边框颜色为红色
                    $(this).next('.select2').find('.select2-selection').css('border', '1px solid red');
                }
            });
        });


        // 遍歷所有語文的表單
        $('.language_group').each(function (index) {                        
            if (index >= 1) {
                let isEmpty = true;
                let language = $(this).find('select[name*="language"]').val();                

                if (language ) {
                    isEmpty = false;
                }

                if (isEmpty) {
                    $(this).addClass('hiddenlanguage');
                }               
            }

            // 用來控制語文model的必填欄位
            $(this).find('select[name*="language"]').on("change", function () {
                if ($(this).val()) {
                    $(this).closest('.language_group').find('select[name*="listen"]').prop('required', true);
                    $(this).closest('.language_group').find('select[name*="speak"]').prop('required', true);
                    $(this).closest('.language_group').find('select[name*="read"]').prop('required', true);
                    $(this).closest('.language_group').find('select[name*="write"]').prop('required', true);
                } else {
                    $(this).closest('.language_group').find('select[name*="listen"]').prop('required', false);
                    $(this).closest('.language_group').find('select[name*="speak"]').prop('required', false);
                    $(this).closest('.language_group').find('select[name*="read"]').prop('required', false);
                    $(this).closest('.language_group').find('select[name*="write"]').prop('required', false);
                }
            });
        });




    })
</script>

{% endblock extra_js_body %}